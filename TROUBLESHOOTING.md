# 故障排查指南

本文档提供常见问题的解决方法和故障排查步骤。

## 常见错误

### 1. 插件加载失败：未找到 Lark 平台适配器

**错误信息：**
```
Lark adapter not found in platform manager
插件未启用：未找到 Lark 平台适配器
```

**原因：**
- 未配置飞书（Lark）平台适配器
- 飞书平台适配器配置不正确
- 飞书平台适配器未启动

**解决方法：**

1. 检查 AstrBot 配置文件中是否已添加飞书平台配置
2. 确保飞书平台适配器已启用
3. 检查飞书应用凭证（App ID 和 App Secret）是否正确
4. 重启 AstrBot 使配置生效

**配置示例：**
```json
{
  "platform": {
    "lark": {
      "enabled": true,
      "app_id": "your_app_id",
      "app_secret": "your_app_secret"
    }
  }
}
```

### 2. 消息获取失败

**错误信息：**
```
未获取到历史消息
历史消息获取失败
```

**可能原因：**
- 飞书机器人权限不足
- 群组 ID 不正确
- API 调用超时或失败
- 时间范围内没有消息

**解决方法：**

1. **检查机器人权限：**
   - 确保飞书应用已获得以下权限：
     - `im:message:read_v1` - 读取群聊消息
     - `im:message.group_msg:readonly` - 读取群组消息
     - `contact:user.base:readonly` - 读取用户基本信息

2. **验证群组 ID：**
   - 使用 `/历史消息示例` 命令测试消息获取
   - 检查日志中的群组 ID 是否正确

3. **检查网络连接：**
   - 确保服务器可以访问飞书 API
   - 检查防火墙设置

4. **调整时间范围：**
   - 尝试减少分析天数（如从 7 天改为 1 天）
   - 确保时间范围内有足够的消息

### 3. 用户信息获取失败 / 用户名称显示为"用户xxxxx"

**现象：**
```
报告中用户名称显示为 "用户b492d" 而不是真实姓名
日志显示: Lark API returned error for user ou_xxx: code=99992351
```

**原因：**
- 飞书应用缺少 `contact:user.base:readonly` 权限
- 或者用户不在机器人的可见范围内

**解决方法：**

**方案 1：配置飞书应用权限（推荐）**

1. 登录飞书开放平台 (https://open.feishu.cn/)
2. 进入你的应用管理页面
3. 点击"权限管理"
4. 添加以下权限：
   - `contact:user.base:readonly` - 获取用户基本信息
   - `im:chat:readonly` - 获取群组信息
5. 保存后，需要重新发布应用版本
6. 在群组中重新添加机器人

**方案 2：使用降级显示（当前方案）**

如果无法配置权限，插件会自动使用降级方案：
- 显示格式：`用户xxxxx`（其中 xxxxx 是 open_id 的前几位）
- 例如：`ou_b492d551235...` 会显示为 `用户b492d`
- 虽然不是真实姓名，但可以通过 ID 区分不同用户

**方案 3：手动配置用户名称映射（未来功能）**

可以在配置文件中手动添加用户名称映射：
```json
{
  "user_name_mapping": {
    "ou_b492d551235de6197c39d22b58231180": "张三",
    "ou_a123456789abcdef": "李四"
  }
}
```

**注意事项：**
- 降级方案不影响插件的其他功能
- 分析结果仍然准确，只是显示名称不同
- 建议配置正确的权限以获得最佳体验

### 4. LLM 分析失败

**错误信息：**
```
LLM请求失败
话题分析调用LLM失败
```

**可能原因：**
- LLM 服务商未配置
- API 密钥无效
- 请求超时
- 配额不足

**解决方法：**

1. **检查 LLM 配置：**
   - 确保已在 AstrBot 中配置 LLM 服务商
   - 验证 API 密钥是否正确
   - 检查 API 端点是否可访问

2. **调整超时设置：**
   ```json
   {
     "llm_timeout": 60,
     "llm_retries": 3
   }
   ```

3. **检查配额：**
   - 查看 LLM 服务商的使用配额
   - 确认账户余额充足

4. **使用自定义 LLM：**
   - 可以配置自定义 API 端点
   - 支持兼容 OpenAI 格式的 API

### 5. JSON 解析失败

**错误信息：**
```
JSON解析失败
话题分析JSON解析失败
```

**可能原因：**
- LLM 返回格式不正确
- 响应包含特殊字符
- 响应被截断

**解决方法：**

1. 插件会自动尝试修复 JSON 格式
2. 如果修复失败，会使用正则表达式提取
3. 最后会使用降级方案返回默认内容
4. 查看日志中的原始响应以诊断问题

### 6. 报告生成失败

**错误信息：**
```
报告生成失败
图片生成失败
```

**可能原因：**
- 缺少依赖库
- 模板文件损坏
- 内存不足
- 用户头像下载失败

**解决方法：**

1. **检查依赖：**
   ```bash
   pip install jinja2 matplotlib pillow
   ```

2. **使用文本格式：**
   - 如果图片生成失败，插件会自动降级到文本格式
   - 可以在配置中设置默认使用文本格式

3. **检查模板：**
   - 确保 `src/reports/templates.py` 文件完整
   - 检查模板语法是否正确

4. **处理头像问题：**
   - 插件会自动处理头像下载失败的情况
   - 使用占位符代替无法加载的头像

### 7. 定时任务不工作

**错误信息：**
```
自动推送未触发
调度器启动失败
```

**可能原因：**
- 自动推送未启用
- 时间配置不正确
- 目标群组未配置

**解决方法：**

1. **检查配置：**
   ```json
   {
     "auto_push_enabled": true,
     "auto_push_time": "09:00",
     "auto_push_groups": ["chat_id_1", "chat_id_2"]
   }
   ```

2. **验证时间格式：**
   - 使用 24 小时制（HH:MM）
   - 例如：`"09:00"` 或 `"21:30"`

3. **检查群组 ID：**
   - 确保群组 ID 正确
   - 可以通过 `/群分析` 命令在群中获取群组 ID

## 调试技巧

### 启用详细日志

在 AstrBot 配置中设置日志级别为 DEBUG：

```json
{
  "log_level": "DEBUG"
}
```

这将输出更详细的调试信息，包括：
- API 请求和响应
- 消息解析详情
- LLM 交互内容
- 缓存命中情况

### 使用测试命令

1. **测试消息获取：**
   ```
   /历史消息示例 1
   ```
   查看是否能正常获取和解析消息

2. **测试分析功能：**
   ```
   /群分析 1
   ```
   使用最短时间范围测试完整流程

### 检查日志文件

查看 AstrBot 日志文件，搜索关键词：
- `[ERRO]` - 错误信息
- `[WARN]` - 警告信息
- `lark` - 飞书相关日志
- `LLM` - LLM 相关日志

### 验证配置

使用配置查询命令：
```
/群分析配置
```

检查当前配置是否正确。

## 性能优化

### 1. 减少消息数量

如果分析速度慢，可以：
- 减少分析天数（1-3 天）
- 降低最大消息数量限制
- 过滤掉不重要的消息类型

### 2. 调整缓存设置

用户信息缓存默认 TTL 为 1 小时，可以根据需要调整：
```python
user_info_cache = UserInfoCache(lark_client_manager, ttl=7200)  # 2小时
```

### 3. 优化 LLM 调用

- 使用更快的 LLM 模型
- 减少最大 token 数
- 调整温度参数

## 获取帮助

如果以上方法都无法解决问题：

1. **查看完整日志：**
   - 收集完整的错误日志
   - 包括错误发生前后的上下文

2. **检查环境：**
   - Python 版本
   - AstrBot 版本
   - 依赖库版本

3. **提交 Issue：**
   - 在 GitHub 上提交 Issue
   - 提供详细的错误信息和日志
   - 说明复现步骤

4. **联系开发者：**
   - 通过 GitHub Issue 联系
   - 提供必要的调试信息（注意隐藏敏感信息）

## FAQ

### Q: 为什么有些用户显示为 "User_xxx"？

A: 这通常是因为：
- 用户信息获取失败
- 用户已离开群组
- API 权限不足

插件会自动使用降级方案，不影响其他功能。

### Q: 分析结果不准确怎么办？

A: 可以尝试：
- 增加分析的消息数量
- 调整 LLM 提示词（需要修改代码）
- 使用更强大的 LLM 模型
- 确保消息解析正确

### Q: 可以自定义报告样式吗？

A: 可以，修改以下文件：
- `src/reports/templates.py` - 报告模板
- `src/visualization/activity_charts.py` - 图表样式

### Q: 支持哪些 LLM 服务商？

A: 支持：
- AstrBot 配置的任何 LLM 服务商
- 自定义 OpenAI 兼容 API
- 可以通过配置指定特定模型

### Q: 如何备份和恢复配置？

A: 配置存储在 AstrBot 的配置文件中，备份该文件即可。插件本身不存储额外的配置文件。

### Q: 插件会消耗多少 API 配额？

A: 取决于：
- 消息数量
- 分析频率
- LLM 模型选择

一次典型的分析（100 条消息）大约消耗：
- 话题分析：2000-5000 tokens
- 用户分析：1000-3000 tokens
- 金句分析：1000-2000 tokens

总计约 4000-10000 tokens。
