# AstrBot 飞书群聊日报插件

一个为 AstrBot 设计的飞书（Lark）群聊日报分析插件，能够自动分析群聊消息，生成包含话题总结、用户画像、金句摘录和活动统计的每日报告。

## 功能特性

- 📊 **智能话题分析**：使用 LLM 自动提取和总结群聊中的主要讨论话题
- 👥 **用户活跃度分析**：为活跃用户生成个性化标签和 MBTI 类型
- 💬 **金句摘录**：自动提取群聊中有趣、有价值的发言
- 📈 **活动统计**：展示消息数量、活跃时段、参与人数等统计数据
- 🎨 **多种报告格式**：支持文本、图片和 PDF 格式的报告输出
- ⏰ **定时推送**：支持每日自动生成和推送分析报告
- 🖼️ **用户头像展示**：报告中包含真实的用户昵称和头像

## 架构设计

### 模块结构

插件采用清晰的模块化架构，各模块职责明确：

```
src/
├── lark/                    # 飞书平台集成
│   ├── client.py           # 飞书 SDK 客户端管理
│   ├── message_fetcher.py  # 消息历史获取
│   ├── message_parser.py   # 消息格式解析
│   └── user_info.py        # 用户信息获取和缓存
├── analysis/               # 分析逻辑
│   ├── topics.py          # 话题分析
│   ├── users.py           # 用户活动分析
│   ├── quotes.py          # 金句提取
│   ├── statistics.py      # 统计计算
│   └── llm_analyzer.py    # LLM 分析基类
├── reports/               # 报告生成
│   ├── generators.py      # 报告生成器
│   └── templates.py       # 报告模板
├── visualization/         # 可视化
│   └── activity_charts.py # 活动图表生成
├── scheduler/             # 定时任务
│   └── auto_scheduler.py  # 自动推送调度
├── core/                  # 核心功能
│   └── config.py          # 配置管理
├── utils/                 # 工具函数
│   └── pdf_utils.py       # PDF 生成工具
└── models.py              # 数据模型定义
```

### 核心组件

#### 1. 飞书集成层 (`src/lark/`)

负责与飞书平台的所有交互：

- **LarkClientManager**: 管理飞书 SDK 客户端实例，提供统一的 API 访问接口
- **MessageFetcher**: 从飞书 API 获取群聊历史消息，支持分页和时间范围过滤
- **MessageParser**: 解析飞书消息格式（文本、富文本、系统消息等）为统一的数据结构
- **UserInfoCache**: 获取和缓存用户信息（昵称、头像），减少 API 调用

#### 2. 分析引擎 (`src/analysis/`)

使用 LLM 和统计方法分析消息内容：

- **TopicsAnalyzer**: 提取和总结讨论话题，识别主要讨论内容
- **UsersAnalyzer**: 分析用户活跃度，生成个性化标签和 MBTI 类型
- **QuotesAnalyzer**: 提取有趣、有价值的发言作为金句
- **StatisticsCalculator**: 计算消息统计数据（数量、时段分布、表情使用等）

#### 3. 报告生成器 (`src/reports/`)

将分析结果格式化为可读的报告：

- **ReportGenerator**: 支持多种格式（文本、图片、PDF）的报告生成
- 使用 Jinja2 模板引擎，易于自定义报告样式
- 集成用户头像和活动图表

#### 4. 定时调度器 (`src/scheduler/`)

管理自动推送任务：

- **AutoScheduler**: 支持每日定时生成和推送报告
- 可配置推送时间和目标群组

### 数据流程

```
1. 消息获取
   MessageFetcher → 飞书 API → 原始消息列表

2. 消息解析
   MessageParser → ParsedMessage 对象
   ├── 提取发送者信息
   ├── 解析消息内容
   └── 获取用户昵称和头像

3. 数据分析
   AnalysisEngine
   ├── TopicsAnalyzer → 话题列表
   ├── UsersAnalyzer → 用户标签
   ├── QuotesAnalyzer → 金句列表
   └── StatisticsCalculator → 统计数据

4. 报告生成
   ReportGenerator → 格式化报告
   ├── 文本格式
   ├── 图片格式（含头像和图表）
   └── PDF 格式
```

## 安装和配置

### 前置要求

- AstrBot v4.0+
- Python 3.10+
- 飞书机器人应用（需要消息读取权限）

### 安装步骤

1. 将插件文件夹放置到 AstrBot 的 `data/plugins/` 目录下

2. 安装依赖（如果需要）：
   ```bash
   pip install lark-oapi jinja2 matplotlib
   ```

3. 在 AstrBot 中配置飞书平台适配器

4. 配置插件参数（通过 AstrBot 配置界面或配置文件）

### 配置选项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `analysis_days` | 分析的天数（1-7） | 1 |
| `max_messages` | 最大消息数量 | 1000 |
| `min_messages` | 最小消息数量阈值 | 10 |
| `output_format` | 输出格式（text/image/pdf） | image |
| `enabled_groups` | 启用的群组 ID 列表 | [] |
| `auto_push_enabled` | 是否启用自动推送 | false |
| `auto_push_time` | 自动推送时间（HH:MM） | 09:00 |
| `auto_push_groups` | 自动推送的群组列表 | [] |
| `user_name_mapping` | 用户名称映射（见下文） | {} |

#### 用户名称映射配置

如果无法通过 API 获取用户真实姓名（例如缺少权限），可以手动配置用户名称映射：

```json
{
  "user_name_mapping": {
    "ou_b492d551235de6197c39d22b58231180": "张三",
    "ou_a123456789abcdef0123456789abcdef": "李四",
    "ou_c987654321fedcba9876543210fedcba": "王五"
  }
}
```

**如何获取用户的 open_id**：
1. 运行 `/历史消息示例` 命令
2. 查看 AstrBot 日志，找到类似 `ou_xxxxxxxxxxxx` 的 ID
3. 将 ID 和对应的用户名称添加到配置中

配置示例文件：[config.example.json](./config.example.json)

## 使用方法

### 手动触发分析

在飞书群聊中发送命令：

```
/群分析
```

或带参数：

```
/群分析 3天
/群分析 7天 文本
```

### 查看历史消息示例

```
/历史消息示例
```

查看插件能够获取的消息格式示例。

### 自动推送

在配置中启用自动推送后，插件会在指定时间自动生成并发送日报到配置的群组。

## 飞书集成说明

### 消息类型支持

插件支持解析以下飞书消息类型：

1. **文本消息** (`text`): 普通文本消息
2. **富文本消息** (`post`): 包含标题、段落、链接等的结构化消息
3. **系统消息** (`system`): 如"用户 A 邀请了用户 B"等系统通知

### 用户信息获取

插件通过飞书 API 获取真实的用户信息：

- 使用 `open_id` 识别用户
- 获取用户昵称（优先使用群昵称）
- 获取用户头像 URL
- 实现缓存机制减少 API 调用（TTL: 1小时）

### API 权限要求

飞书机器人应用需要以下权限：

- `im:message:read_v1`: 读取群聊消息
- `im:message.group_msg:readonly`: 读取群组消息
- `contact:user.base:readonly`: 读取用户基本信息（**必需**，用于获取用户真实姓名）

#### 如何配置权限

1. 登录飞书开放平台：https://open.feishu.cn/
2. 选择你的应用
3. 点击左侧菜单"权限管理"
4. 搜索并添加以下权限：
   - **获取用户基本信息** (`contact:user.base:readonly`)
   - **获取群组消息** (`im:message.group_msg:readonly`)
   - **读取消息** (`im:message:read_v1`)
5. 点击"保存"
6. 在"版本管理与发布"中创建新版本并发布
7. 在群组中重新添加机器人（或等待权限生效）

**注意**：如果没有配置 `contact:user.base:readonly` 权限，插件仍然可以工作，但用户名称会显示为"用户xxxxx"格式。你可以通过配置文件手动设置用户名称映射（见下文）。

## 报告示例

### 文本格式报告

```
📊 群聊日报 - 2025年10月5日

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 数据概览
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 消息总数: 156 条
💬 总字符数: 8,234 字
👥 参与人数: 12 人
⏰ 活跃时段: 14:00-15:00, 20:00-21:00, 21:00-22:00

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔥 热门话题
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 项目进度讨论
   参与者: 张三, 李四, 王五
   讨论了新功能的开发进度和技术方案...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
👤 活跃用户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏆 张三 - 话痨王
   MBTI: ENFP
   发言 45 条，总是有说不完的话题...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💎 今日金句
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

"代码写得好不好，看注释就知道" - 张三
```

### 图片格式报告

图片报告包含：
- 用户头像展示
- 活动时段图表
- 彩色主题设计
- 完整的分析内容

## 故障排查

请参考 [故障排查指南](./TROUBLESHOOTING.md) 了解常见问题的解决方法。

## 开发和测试

### 运行测试

```bash
python run_tests.py
```

详细的测试说明请参考 [测试文档](./tests/README.md)。

### 代码结构

所有核心代码都包含详细的中文注释和类型提示，便于理解和维护。

## 许可证

本插件遵循 MIT 许可证。

## 贡献

欢迎提交 Issue 和 Pull Request！

## 更新日志

### v2.0.0 (重构版本)

- ✨ 完全重构架构，采用模块化设计
- ✨ 正确支持飞书消息格式解析
- ✨ 使用真实用户昵称和头像
- ✨ 改进 LLM 分析提示词，提升分析质量
- ✨ 添加用户信息缓存机制
- ✨ 增强错误处理和日志记录
- ✨ 支持多种报告格式输出
- 🐛 修复时间戳转换问题
- 🐛 修复用户识别问题
- 📝 完善文档和注释

### v1.x

- 初始版本（从 QQ 插件移植）
